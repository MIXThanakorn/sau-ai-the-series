<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ลงทะเบียนเข้าร่วมโครงการ - AI THE SERIES FOR SAU-INSTRUCTOR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap");

      body {
        font-family: "Noto Sans Thai", sans-serif;
      }

      .bg-gradient-sau {
        background: linear-gradient(
          135deg,
          #1e3a8a 0%,
          #3b82f6 50%,
          #06b6d4 100%
        );
      }

      .card-shadow {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      .image-preview {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #3b82f6;
      }

      .grid-item {
        transition: transform 0.3s ease;
      }

      .grid-item:hover {
        transform: translateY(-5px);
      }

      .loading {
        border: 4px solid #f3f4f6;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <header class="bg-gradient-sau py-8 px-4">
      <div class="container mx-auto text-center">
        <h1 class="text-2xl font-bold text-white mb-2">
          ลงทะเบียนเข้าร่วมโครงการ
        </h1>
        <h2 class="text-xl font-bold text-white mb-4">
          AI THE SERIES FOR SAU-INSTRUCTOR
        </h2>

        <div
          class="w-20 h-20 bg-white rounded-full mx-auto mb-4 flex items-center justify-center"
        >
          <img src="./images/saulogo.png" alt="sau logo" />
        </div>

        <p class="text-lg text-white">มหาวิทยาลัยเอเชียอาคเนย์</p>
      </div>
    </header>

    <main class="container mx-auto px-4 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white rounded-lg card-shadow p-6">
          <h3
            class="text-2xl font-semibold text-gray-800 mb-6 border-b-2 border-blue-500 pb-2"
          >
            การลงทะเบียน
          </h3>

          <form id="registrationForm" class="space-y-6">
            <div class="text-center">
              <div class="mb-4">
                <img
                  id="imagePreview"
                  class="image-preview mx-auto hidden"
                  alt="Preview"
                />
                <div
                  id="imagePlaceholder"
                  class="w-32 h-32 bg-gray-200 rounded-full mx-auto flex items-center justify-center border-2 border-dashed border-gray-400"
                >
                  <svg
                    class="w-12 h-12 text-gray-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                    ></path>
                  </svg>
                </div>
              </div>
              <input
                type="file"
                id="imageInput"
                accept="image/*"
                class="hidden"
              />
              <button
                type="button"
                id="uploadBtn"
                class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors"
              >
                อัพโหลดรูปภาพ
              </button>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >ชื่อ-สกุล *</label
              >
              <input
                type="text"
                id="fullName"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="กรอกชื่อ-สกุล"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >สังกัด (คณะ) *</label
              >
              <select
                id="major"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="">เลือกสังกัด</option>
                <option value="บัณฑิตวิทยาลัย">บัณฑิตวิทยาลัย</option>
                <option value="คณะวิศวกรรมศาสตร์">คณะวิศวกรรมศาสตร์</option>
                <option value="คณะบริหารธุรกิจ">คณะบริหารธุรกิจ</option>
                <option value="คณะนิติศาสตร์">คณะนิติศาสตร์</option>
                <option value="คณะศิลปศาสตร์และวิทยาศาสตร์">
                  คณะศิลปศาสตร์และวิทยาศาสตร์
                </option>
                <option value="อื่นๆ">อื่นๆ (โปรดระบุ)</option>
              </select>
            </div>

            <div id="otherDepartment" class="hidden">
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >โปรดระบุสังกัด *</label
              >
              <input
                type="text"
                id="otherMajor"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="กรอกสังกัด"
              />
            </div>

            <button
              type="submit"
              id="submitBtn"
              class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center"
            >
              <span id="submitText">บันทึกข้อมูล</span>
              <div id="submitLoading" class="loading ml-2 hidden"></div>
            </button>
          </form>
        </div>

        <div class="bg-white rounded-lg card-shadow p-6">
          <h3
            class="text-2xl font-semibold text-gray-800 mb-6 border-b-2 border-blue-500 pb-2"
          >
            ผลการลงทะเบียน
          </h3>

          <div id="loadingResults" class="text-center py-8">
            <div class="loading mx-auto mb-4"></div>
            <p class="text-gray-600">กำลังโหลดข้อมูล...</p>
          </div>

          <div
            id="registrationResults"
            class="grid grid-cols-2 md:grid-cols-2 xl:grid-cols-3 gap-4 hidden"
          ></div>

          <div id="noResults" class="text-center py-8 hidden">
            <p class="text-gray-600">ยังไม่มีการลงทะเบียน</p>
          </div>
        </div>
      </div>
    </main>

    <script>
      const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbx6zgPdxQmvyXEVGSFqtJ2va_AxQcXJ3zhUJo86fkSjs3AAd9Diqc48ddkDlNhRB5E6pA/exec";
      let selectedImage = null;

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        loadRegistrationData();
        setupEventListeners();
      });

      function setupEventListeners() {
        // Image upload
        document
          .getElementById("uploadBtn")
          .addEventListener("click", function () {
            document.getElementById("imageInput").click();
          });

        document
          .getElementById("imageInput")
          .addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function (e) {
                const preview = document.getElementById("imagePreview");
                const placeholder = document.getElementById("imagePlaceholder");

                preview.src = e.target.result;
                preview.classList.remove("hidden");
                placeholder.classList.add("hidden");

                selectedImage = file;
              };
              reader.readAsDataURL(file);
            }
          });

        // Department selection
        document
          .getElementById("major")
          .addEventListener("change", function () {
            const otherDepartment = document.getElementById("otherDepartment");
            const otherMajor = document.getElementById("otherMajor");

            if (this.value === "อื่นๆ") {
              otherDepartment.classList.remove("hidden");
              otherMajor.setAttribute("required", "required");
            } else {
              otherDepartment.classList.add("hidden");
              otherMajor.removeAttribute("required");
              otherMajor.value = "";
            }
          });

        // Form submission
        document
          .getElementById("registrationForm")
          .addEventListener("submit", handleSubmit);
      }

      async function handleSubmit(e) {
        e.preventDefault();

        const submitBtn = document.getElementById("submitBtn");
        const submitText = document.getElementById("submitText");
        const submitLoading = document.getElementById("submitLoading");

        // Show loading
        submitBtn.disabled = true;
        submitText.textContent = "กำลังบันทึก...";
        submitLoading.classList.remove("hidden");

        try {
          const fullName = document.getElementById("fullName").value;
          const major = document.getElementById("major").value;
          const otherMajor = document.getElementById("otherMajor").value;

          const finalMajor = major === "อื่นๆ" ? otherMajor : major;

          if (!selectedImage) {
            throw new Error("กรุณาอัพโหลดรูปภาพ");
          }

          // Convert image to base64
          const imageBase64 = await fileToBase64(selectedImage);

          // Create FormData for Google Apps Script
          const formData = new FormData();
          formData.append("action", "register");
          formData.append("fullName", fullName);
          formData.append("major", finalMajor);
          formData.append("image", imageBase64);
          formData.append("fileName", selectedImage.name);
          formData.append("fileType", selectedImage.type);

          const response = await fetch(SCRIPT_URL, {
            method: "POST",
            body: formData,
            mode: "no-cors",
          });

          // Since we're using no-cors, we can't read the response
          // We'll assume success and reload data
          alert("ลงทะเบียนสำเร็จ!");
          clearForm();
          setTimeout(() => {
            loadRegistrationData();
          }, 2000);
        } catch (error) {
          console.error("Error:", error);
          alert("เกิดข้อผิดพลาด: " + error.message);
        } finally {
          // Hide loading
          submitBtn.disabled = false;
          submitText.textContent = "บันทึกข้อมูล";
          submitLoading.classList.add("hidden");
        }
      }

      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result.split(",")[1]);
          reader.onerror = (error) => reject(error);
        });
      }

      function clearForm() {
        document.getElementById("registrationForm").reset();
        document.getElementById("imagePreview").classList.add("hidden");
        document.getElementById("imagePlaceholder").classList.remove("hidden");
        document.getElementById("otherDepartment").classList.add("hidden");
        document.getElementById("otherMajor").removeAttribute("required");
        selectedImage = null;
      }

      async function loadRegistrationData() {
        const loadingResults = document.getElementById("loadingResults");
        const registrationResults = document.getElementById(
          "registrationResults"
        );
        const noResults = document.getElementById("noResults");

        loadingResults.classList.remove("hidden");
        registrationResults.classList.add("hidden");
        noResults.classList.add("hidden");

        try {
          // Use JSONP approach for GET requests
          const response = await fetchWithJSONP(
            SCRIPT_URL + "?action=getRegistrations"
          );

          loadingResults.classList.add("hidden");

          if (
            response.success &&
            response.registrations &&
            response.registrations.length > 0
          ) {
            displayResults(response.registrations);
            registrationResults.classList.remove("hidden");
          } else {
            noResults.classList.remove("hidden");
          }
        } catch (error) {
          console.error("Error loading data:", error);
          loadingResults.classList.add("hidden");
          noResults.classList.remove("hidden");
        }
      }

      function fetchWithJSONP(url) {
        return new Promise((resolve, reject) => {
          const script = document.createElement("script");
          const callbackName =
            "jsonp_callback_" + Math.round(100000 * Math.random());

          // Add callback parameter to URL
          const separator = url.includes("?") ? "&" : "?";
          script.src = url + separator + "callback=" + callbackName;

          window[callbackName] = function (data) {
            delete window[callbackName];
            document.head.removeChild(script);
            resolve(data);
          };

          script.onerror = function () {
            delete window[callbackName];
            document.head.removeChild(script);
            reject(new Error("JSONP request failed"));
          };

          document.head.appendChild(script);
        });
      }

      function displayResults(registrations) {
        const container = document.getElementById("registrationResults");
        container.innerHTML = "";

        // Sort registrations by 'no' in descending order (latest first)
        registrations.sort((a, b) => b.no - a.no); //

        registrations.forEach((registration) => {
          const card = document.createElement("div");
          card.className = "grid-item bg-gray-50 p-4 rounded-lg text-center";

          const imageUrl =
            registration.imageUrl ||
            "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxjaXJjbGUgY3g9IjUwIiBjeT0iMzUiIHI9IjEwIiBmaWxsPSIjOUNBM0FGIi8+CjxwYXRoIGQ9Ik0zMCA2NUSzMCA1OC4zNzI2IDM1LjM3MjYgNTMgNDIgNTNINThDNjQuNjI3NCA1MyA3MCA1OC4zNzI2IDcwIDY1VjcwSDMwVjY1WiIgZmlsbD0iIzlCQTNBRiIvPgo8L3N2Zz4K";

          card.innerHTML = `
                <img src="${imageUrl}" alt="${registration.fullName}" class="w-16 h-16 rounded-full mx-auto mb-3 object-cover border-2 border-blue-500">
                <h4 class="font-semibold text-gray-800 mb-1" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${registration.fullName}</h4>
                <p class="text-sm text-gray-600">${registration.major}</p>
            `;

          container.appendChild(card);
        });
      }
    </script>
  </body>
</html>
